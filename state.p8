pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
	start_game()
	b = ''
end

function _update60()
	handle_input()
end

function _draw()
	cls()
	player.draw()
	print(player.state.name)
	print(b)
end

function start_game()
	dir_x = {-1,1,0,0}
	dir_y = {0,0,-1,1}
	player = create_actor()
end
-->8
function handle_input()
	local pressed = false
	for i=0,3 do 
		if btn(i) then
			player.handle_input(i)
			pressed = true
		end
	end
	if not pressed then
		player.handle_input()
	end
end
-->8
--actor

function create_actor()
	local a = {}
	a.x = 0
	a.y = 0
	a.frames = 0
	a.sprites = {}
	a.flp = false
	a.state = create_standing_state()
	a.state.enter(a)
	
	a.handle_input = function(input)
		local state = a.state.handle_input(a,input)
		if state then
			a.state = state
			a.state.enter(a)
			a.frames = 0
		end
	end
	
	a.move = function(x,y)
		a.x = x
		a.y = y
	end
	
	a.current_sprite = function()
		local curr_frame = flr(a.frames / 10) % #a.sprites
		local index = a.sprites[1 + curr_frame]
		return {
			x = index % 4 * 19,
			y = flr(index / 4) * 24
		} 
	end
	
	a.draw = function()
		local sp = a.current_sprite()
		sspr(sp.x, sp.y, 19, 24, a.x, a.y, 19, 24, a.flp)
		a.frames+=1
	end
	
	return a
end


-->8

function create_standing_state()
	local s = {}
	s.name="standing"
	s.handle_input = function(_actor, input)
		if not input then return nil end
		if input >= 0 and input < 4 then
			return create_walking_state()
		end
	end
	
	s.enter = function(_actor)
		_actor.sprites = {12}
		_actor.flp = false
	end
	
	return s
end

function create_walking_state()
	local s = {}
	local walk_sprites = {
		{s={4,5,6,7}, flp=true},
		{s={4,5,6,7}},
		{s={8,9,10,11}},
		{s={0,1,2,3}}
	}
	
	s.name="walking"
	
	s.handle_input = function(_actor, input)
		if not input then
			return create_standing_state()
		end
		
		local dx = dir_x[input+1]
		local dy = dir_y[input+1]
		_actor.sprites = walk_sprites[input+1].s
		_actor.flp=walk_sprites[input+1].flp or false
		_actor.move(_actor.x + dx, _actor.y + dy)
	end
	
	s.enter = function(_actor)
		_actor.sprites = walk_sprites[3].s
		_actor.flp = walk_sprites[3].flp or false
	end
	
	return s
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000111110011100000000000000000000000000001111100111000000000000000000000000000000000000000000000000000000000000000000000000000
000014ff44114f410000000011111001110000000014ff44114f4100000000111110011100000000000000000000000000000000000000000000000000000000
00011444f414f411000000014ff44114f4100000011444f414f411000000014ff44114f410000000000000000000000000000000000000000000000000000000
001114f44444441100000011444f414f411000001114f44444441100000011444f414f4110000000000000000000000000000000000000000000000000000000
0014ff4114444f41100001114f4444444110000014ff4114444f41100001114f4444444110000000000000000000000000000000000000000000000000000000
001111144f4114ff1000014ff4114444f41100001111144f4114ff1000014ff4114444f411000000000000000000000000000000000000000000000000000000
0001114ff4141144100001111144f4114ff1000001114ff4141144100001111144f4114ff1000000000000000000000000000000000000000000000000000000
00001111414f41110000001114ff414114410000001111414f41110000001114ff41411441000000000000000000000000000000000000000000000000000000
00011f1f1ff1f1f100000001111414f411100000011f1f1ff1f1f100000001111414f41110000000000000000000000000000000000000000000000000000000
0001414f1ff1f41410000011f1f1ff1f1f10000001414f1ff1f41410000011f1f1ff1f1f10000000000000000000000000000000000000000000000000000000
00011414ffff41411000001414f1ff1f41410000011414ffff41411000001414f1ff1f4141000000000000000000000000000000000000000000000000000000
000011111111111100000011414ffff4141100000011111111111100000011414ffff41411000000000000000000000000000000000000000000000000000000
00001141c11c1411000000011111111111100000001141c11c141100000001111111111110000000000000000000000000000000000000000000000000000000
00011411c11c114110000001141c11c141100000011411c11c114110000001141c11c14110000000000000000000000000000000000000000000000000000000
001f4111fccf1114f1000001f41111c1111000001f4111fccf1114f1000001111c11114f10000000000000000000000000000000000000000000000000000000
001fff14c11c41fff1000001fff1ccf114f100001fff14c11c41fff100001f411fcc1fff10000000000000000000000000000000000000000000000000000000
001ff4114ff4114ff1000001ff4111c41f4100001ff4114ff4114ff1000014f14c1114ff10000000000000000000000000000000000000000000000000000000
00011111cccc1111100000001114ff4111100000011111cccc1111100000011114ff411100000000000000000000000000000000000000000000000000000000
00000011111cc10000000000001cccc11000000000001cc111110000000000011cccc10000000000000000000000000000000000000000000000000000000000
00000001101cc10000000000000111c10000000000001cc101100000000000001c11100000000000000000000000000000000000000000000000000000000000
00000000001111000000000000000111000000000000111100000000000000001110000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000111011111000000000000000000000000000001110111110000000000000000000000000000000000000000000000000000000000000000000000000000
000014f4114ff4100000000011101111100000000014f4114ff41000000000111011111000000000000000000000000000000000000000000000000000000000
0000114f14f44411000000014f4114ff4100000000114f14f44411000000014f4114ff4100000000000000000000000000000000000000000000000000000000
000011444444f4111000000114f14f44411000000011444444f4111000000114f14f444110000000000000000000000000000000000000000000000000000000
00011114f4114ff4100000011444444f41110000011114f4114ff4100000011444444f4111000000000000000000000000000000000000000000000000000000
000141ff4144111110000011114f4114ff4100000141ff4144111110000011114f4114ff41000000000000000000000000000000000000000000000000000000
0001114411ff4111000000141ff414411111000001114411ff4111000000141ff414411111000000000000000000000000000000000000000000000000000000
00014111144ff1100000001114411ff411100000014111144ff1100000001114411ff41110000000000000000000000000000000000000000000000000000000
000114114f1ff10000000014111144ff110000000114114f1ff10000000014111144ff1100000000000000000000000000000000000000000000000000000000
0014411f4f1ff100000000114114f1ff1000000014411f4f1ff100000000114114f1ff1000000000000000000000000000000000000000000000000000000000
00111111ffff41000000014411f4f1ff10000000111111ffff41000000014411f4f1ff1000000000000000000000000000000000000000000000000000000000
00001f141111100000000111111ffff410000000001f141111100000000111111ffff41000000000000000000000000000000000000000000000000000000000
000144111111410000000001f1411111000000000144111111410000000001f14111110000000000000000000000000000000000000000000000000000000000
0001411441fff41000000014411111141000000001411441fff41000000014411111141000000000000000000000000000000000000000000000000000000000
0000111141fff1100000001411441fff4100000000111141fff1100000001411441fff4100000000000000000000000000000000000000000000000000000000
00000001114ff1100000000111141fff11000000000001114ff1100000000111141fff1100000000000000000000000000000000000000000000000000000000
000000014411110000000000001114ff110000000000014411110000000000001114ff1100000000000000000000000000000000000000000000000000000000
000000111cc1000000000000001111111000000000000011c1000000000000001441111000000000000000000000000000000000000000000000000000000000
000000111c1100000000000001c1111100000000000000111100000000000000111c110000000000000000000000000000000000000000000000000000000000
00000000111100000000000011110011110000000000001111100000000000011101111100000000000000000000000000000000000000000000000000000000
00000000111110000000000011111001100000000000001110000000000000111100111000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011100111110000000000000000000000000000111001111100000000000000000000000000000000000000000000000000000000
0000011100111110000000014f41144ff410000000011100111110000000014f41144ff410000000000000000000000000000000000000000000000000000000
000014f41144ff410000000114f414f4441100000014f41144ff410000000114f414f44411000000000000000000000000000000000000000000000000000000
0000114f414f44411000000114444444f411100000114f414f44411000000114444444f411100000000000000000000000000000000000000000000000000000
0000114444444f41110000114f4444114ff4100000114444444f41110000114f4444114ff4100000000000000000000000000000000000000000000000000000
000114f4444114ff4100001ff4144f44111110000114f4444114ff4100001ff4144f441111100000000000000000000000000000000000000000000000000000
0001ff4144f4411111000014411414ff4111000001ff4144f4411111000014411414ff4111000000000000000000000000000000000000000000000000000000
00014411414ff411100000011144411411100000014411414ff41110000001114441141110000000000000000000000000000000000000000000000000000000
00001114441141110000000144444444441100000011144411411100000001444444444411000000000000000000000000000000000000000000000000000000
00001444444444411000001441444114144100000014444444444110000014414441141441000000000000000000000000000000000000000000000000000000
00014414441141441000001141114411141100000144144411414410000011411144111411000000000000000000000000000000000000000000000000000000
0001141114411141100000011111ff111110000001141114411141100000011111ff111110000000000000000000000000000000000000000000000000000000
000011111ff111110000000114144441411000000011111ff1111100000001141444414110000000000000000000000000000000000000000000000000000000
00001141444414110000000011114411110000000011414444141100000000111144111100000000000000000000000000000000000000000000000000000000
000001111441111000000000111c11c1110000000001111441111000000000111c11c11100000000000000000000000000000000000000000000000000000000
00000111c11c1110000000000141cc1410000000000111c11c1110000000000141cc141000000000000000000000000000000000000000000000000000000000
000000141cc14100000000000114ff41100000000000141cc14100000000000114ff411000000000000000000000000000000000000000000000000000000000
000000114ff4110000000000011ccc1c100000000000114ff411000000000001c1ccc11000000000000000000000000000000000000000000000000000000000
00000001111c110000000000011111cc10000000000011c11110000000000001cc11111000000000000000000000000000000000000000000000000000000000
00000000001c100000000000001101cc10000000000001c10000000000000001cc10110000000000000000000000000000000000000000000000000000000000
00000000001110000000000000000111100000000000011100000000000000011110000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000111110011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000014ff44114f410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011444f414f4110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001114f4444444110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0014ff4114444f411000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001111144f4114ff1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001114ff41411441000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00001111414f41110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011f1f1ff1f1f10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001414f1ff1f4141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011414ffff41411000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00001111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00001141c11c14110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011411c11c11411000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001f4111fccf1114f100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001fff14c11c41fff100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001ff4114ff4114ff100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011111cccc11111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001c1111c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001c1001c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000111100111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
